{% load static %}
{% load humanize %}
{% load realestate_filter %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
        <style>
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="{% static 'js/common.js' %}"></script>
        <script type="text/javascript">
            $(function(){
                $('#btn_dandok').click(function() {
                    $('#DDDGG').prop("checked", true);
                    $('#JWJT').prop("checked", true);
                    $('#HOJT').prop("checked", true);
                    $('#TJ').prop("checked", false);
                    $('#building_type_ddonly').prop("checked", true);
                    $('#name_except_filter').val('다가구,원룸')
                });
                $('#btn_daeji').click(function() {
                    $('#DDDGG').prop("checked", false);
                    $('#JWJT').prop("checked", false);
                    $('#HOJT').prop("checked", false);
                    $('#TJ').prop("checked", true);
                    $('#building_type_ddonly').prop("checked", false);
                    $('#name_except_filter').val('전,답,임야,과수원')
                });
                $('#btn_submit').click(function() {
                    $('#page').attr('value', 1)
                    $('#form_search').submit();
                });
                $('#btn_prev').click(function() {
                    var cur_page = parseInt($('#page').attr('value'), 10);
                    $('#page').attr('value', cur_page-1)
                    $('#form_search').submit();
                });
                $('#btn_next').click(function() {
                    var cur_page = parseInt($('#page').attr('value'), 10);
                    $('#page').attr('value', cur_page+1)
                    $('#form_search').submit();
                });

                $('.btn_check').click(function() {
                    var item_id = $(this).attr('item_id');
                    $.ajax({
                        type: "POST",
                        url: "{% url 'realestate:check' %}",
                        data: { 'item_id': item_id },
                        dataType: "json",
                        success: function(response) {
                            if (response.result == "Success") {
                                $('#btn_check_' + item_id).css("display", "None");
                            }
                            else {
                                alert(response.result);
                            }
                        },
                        error: function(request, status, error) {
                            alert(error);
                        },
                    });
                });

                $('.btn_register').click(function() {
                    var item_id = $(this).attr('item_id');
                    var url = "{% url 'realestate:naver_register' %}?item_id=" + item_id;
                    var popup = window.open(url, '등록', 'scrollbars=yes');
                    popup.onbeforeunload = function() {
                        $('#btn_check_' + item_id).css("display", "None");
                        $('#btn_register_' + item_id).css("display", "None");
                    }
                });

                $('.btn_link').click(function() {
                    var item_id = $(this).attr('item_id');
                    var match_id = $(this).attr('match_id');
                    $.ajax({
                        type: "POST",
                        url: "{% url 'realestate:naver_link' %}",
                        data: { 'item_id': item_id, 'match_id': match_id },
                        dataType: "json",
                        success: function(response) {
                            if (response.result == "Success") {
                                $('#btn_check_' + item_id).css("display", "None");
                                $('#btn_link_' + item_id).css("display", "None");
                            }
                            else {
                                alert(response.result);
                            }
                        },
                        error: function(request, status, error) {
                            alert(error);
                        },
                    });
                });
            });
        </script>
    </head>
    <body>
        <div>
            <form action="{% url 'realestate:naver' %}" method="post" id="form_search">
                {% csrf_token %}
                <label>
                    <span>지역</span>
                    <select name="location">
                        {% for item in location_code_list %}
                        {% if cur_location == item.code %}
                        <option value="{{item.code}}" selected="selected">{{item.location}}</option>
                        {% else %}
                        <option value="{{item.code}}">{{item.location}}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </label>
                <fieldset style="margin-top: 10px;">
                    <legend>부동산 종류</legend>
                    <div>
                        {% for item in building_type_list.items %}
                        <label>
                            <span>{{item.0}}</span>
                            {% if item.1 in building_types %}
                            <input type="checkbox" id="{{item.1}}" name="building_type" value="{{item.1}}" checked>
                            {% else %}
                            <input type="checkbox" id="{{item.1}}" name="building_type" value="{{item.1}}">
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                    <div>
                        <label>
                            <span>단독만</span>
                            {% if is_building_type_ddonly %}
                            <input type="checkbox" id="building_type_ddonly" name="building_type_ddonly" value="DDONLY" checked>
                            {% else %}
                            <input type="checkbox" id="building_type_ddonly" name="building_type_ddonly" value="DDONLY">
                            {% endif %}
                        </label>
                    </div>
                </fieldset>
                <div style="margin-top: 10px;">
                    <label>
                        <span>준공연도</span>
                        <input type="number" name="recently_build_years" value="{{recently_build_years}}" style="width: 40px;">년
                        ~
                        <input type="number" name="old_build_years" value="{{old_build_years}}" style="width: 40px;">년
                        이내
                    </label>
                </div>
                <div style="margin-top: 10px;">
                    <label>
                        <span>제목 제외 필터</span>
                        <input type="text" id="name_except_filter" name="name_except_filter" value="{{name_except_filter}}" style="width: 300px;">
                    </label>
                </div>
                <div style="margin-top: 10px;">
                    <label>
                        <span>특정 매물 확인</span>
                        <input type="text" name="article_no" value="" style="width: 300px;">
                    </label>
                </div>
                <div style="margin-top: 10px;">
                    <span>
                        <input type="button" id="btn_dandok" value="단독주택">
                    </span>
                    <span>
                        <input type="button" id="btn_daeji" value="대지">
                    </span>
                </div>
                <div style="margin-top: 10px;">
                    <input type="button" id="btn_submit" value="검색">
                </div>
                <div>
                    <input type="hidden" id="page" name="page" value="{{page}}">
                    {% if page > 1 %}
                    <input type="button" id="btn_prev" value="이전 페이지">
                    {% endif %}
                    {{page}}페이지
                    {% if is_more_data %}
                    <input type="button" id="btn_next" value="다음 페이지">
                    {% endif %}
                </div>
            </form>
        </div>
        <div>
            <table>
                <tr>
                    <th style="width: 50px; text-align: center;">액션</th>
                    <th style="width: 90px; text-align: center;">번호</th>
                    <th style="width: 80px; text-align: center;">제목</th>
                    <th style="width: 90px; text-align: center;">가격</th>
                    <th style="width: 120px; text-align: center;">정보</th>
                    <th style="width: 270px; text-align: center;">주소</th>
                    <th style="text-align: center;">설명</th>
                </tr>
                {% for item in list %}
                {% if item.realestate and item.realestate.is_favorite %}
                <tr id="tr_{{item.naver.id}}" style="background-color: burlywood;">
                {% else %}
                <tr id="tr_{{item.naver.id}}">
                {% endif %}
                    <td>
                        {% if item.myitem.is_new %}
                        <div>
                            <input type="button" id="btn_check_{{item.myitem.id}}" class="btn_check" item_id="{{item.myitem.id}}" value="확인">
                        </div>
                        {% endif %}
                        {% if item.realestate %}
                        {% elif item.realestate_match %}
                        <div>
                            <input type="button" id="btn_link_{{item.myitem.id}}" class="btn_link" item_id="{{item.myitem.id}}" match_id="{{item.realestate_match.id}}" value="연결">
                        </div>
                        {% else %}
                        <div>
                            <input type="button" id="btn_register_{{item.myitem.id}}" class="btn_register" item_id="{{item.myitem.id}}" value="등록">
                        </div>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <div>
                            <span><a href="https://new.land.naver.com/houses?articleNo={{item.naver.id}}" target="_blank">{{item.naver.id}}</a></span>
                        </div>
                        <div>
                            ID ({{item.myitem.id}})
                        </div>
                        <div>
                            연결 ({{item.myitem.realestate_id}})
                        </div>
                        {% if item.realestate_match %}
                        <div>
                            Match ({{item.realestate_match.id}})
                        </div>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">{{item.naver.name}}<br>({{item.naver.subname}})</td>
                    <td style="text-align: right;">
                        <div>{{item.naver.price|intcomma}}만원</div>
                    </td>
                    <td>
                        {{item.naver.all_ho_count}}세대<br>
                        대지:{{item.naver.area}}㎡<br>
                        건축면적:{{item.naver.building_area}}㎡<br>
                        연면적:{{item.naver.total_floor_area}}㎡<br>
                        사용승인일:{{item.naver.use_approve_day2}}
                    </td>
                    <td>
                        <a href="https://map.naver.com/v5/search/{{item.naver.address}}" target="_blank">{{item.naver.address}}</a>
                        {% if item.naver.is_location_address %}
                        <br>(좌표 추정 주소)
                        {% endif %}
                    </td>
                    <td><p>{{item.naver.description|linebreaks}}</p><p>{{item.naver.detailDescription|linebreaks}}</p></td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </body>
</html>